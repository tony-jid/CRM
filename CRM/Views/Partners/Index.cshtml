
@{
    ViewData["Title"] = "Partners";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>@ViewData["Title"]</h2>

@(Html.DevExtreme().DataGrid<Partner>()
            .ID("gridPartners")
            .ShowBorders(true)
            .ShowRowLines(true)
            .ShowColumnLines(false)
            .RemoteOperations(true)
            .FilterRow(f => f.Visible(true))
            .DataSource(ds => ds.Mvc()
                .Controller(nameof(EnumController.Partners))
                .LoadAction("Get")
                .InsertAction("Post")
                .UpdateAction("Put")
                .DeleteAction("Delete")
                .Key("Id")
            )
            .Columns(columns =>
            {
                columns.AddFor(m => m.Logo).Visible(false);
                columns.Add().CellTemplate(@<text>
                    <img src="~/images/partners/hp.png" />
                </text>)
                    .FormItem(f => f.Visible(false)); ;
                columns.AddFor(m => m.Name);
            })
            .Editing(e =>
                e.Mode(GridEditMode.Popup)
                .UseIcons(true)
                .AllowAdding(true)
                .AllowUpdating(true)
                .AllowDeleting(true)
                .Popup(p =>
                    p.Title(nameof(Partner))
                    .Width(600)
                    .ShowTitle(true)
                    .DragEnabled(false)
                    .CloseOnOutsideClick(true)
                    .Position(pos => pos
                        .My(HorizontalAlignment.Center, VerticalAlignment.Top)
                        .At(HorizontalAlignment.Center, VerticalAlignment.Top)
                        .Of(new JS("window"))
                    )
                )
            )
            .MasterDetail(m => m
                .Enabled(true)
                .Template(new TemplateName("grid-partner-details"))
                .AutoExpandAll(false)
            )
            .Selection(s => s.Mode(SelectionMode.Single))
                .OnSelectionChanged(@<text>
                    function(e) {
                        e.component.collapseAll(-1);
                        e.component.expandRow(e.currentSelectedRowKeys[0]);
                    }
                </text>)
)

@using (Html.DevExtreme().NamedTemplate("grid-partner-details"))
{
    @(Html.DevExtreme().TabPanel()
        .FocusStateEnabled(false)
        .ElementAttr("class", "tabPanel")
        .Items(items =>
        {
            items.Add()
                .Title("Branches")
                .Template(new TemplateName("grid-partner-branches"))
                .Option("masterPartner", new { partnerId = new JS("data.Id") });
        })
    )
}

@using (Html.DevExtreme().NamedTemplate("grid-partner-branches"))
{
    @(Html.DevExtreme().DataGrid<PartnerBranch>()
        .ID("grid-partner-branches-" + new JS("masterPartner.partnerId"))
        .ShowBorders(true)
        .HeaderFilter(f => f.Visible(false))
        .DataSource(d => d.Mvc()
            .Controller(nameof(EnumController.PartnerBranches))
            .LoadAction("GetBranchesByPartner")
            .LoadParams(new
            {
                partnerId = new JS("masterPartner.partnerId")
            })
            .InsertAction("Post")
            .UpdateAction("Put")
            .DeleteAction("Delete")
            .Key("Id")
        )
        .Paging(p => p.PageSize(5))
        .Columns(columns =>
        {
            columns.AddFor(m => m.Address.StreetAddress);
            columns.AddFor(m => m.Address.Suburb);
            columns.AddFor(m => m.Address.State);
            columns.AddFor(m => m.Address.PostCode);
        })
        .Editing(e =>
            e.Mode(GridEditMode.Popup)
            .UseIcons(true)
            .AllowAdding(true)
            .AllowUpdating(true)
            .AllowDeleting(true)
            .Form(f =>
                f.Items(i =>
                {
                    i.AddGroup().Caption("Address").ColSpan(2).ColCount(2).Items(groupItems =>
                    {
                        groupItems.AddSimpleFor(c => c.Address.StreetAddress);
                        groupItems.AddSimpleFor(c => c.Address.Suburb);
                        groupItems.AddSimpleFor(c => c.Address.State);
                        groupItems.AddSimpleFor(c => c.Address.PostCode);
                    });
                })
            )
            .Popup(p =>
                p.Title(nameof(PartnerBranch))
                .Width(600)
                .ShowTitle(true)
                .DragEnabled(false)
                .CloseOnOutsideClick(true)
                .Position(pos => pos
                    .My(HorizontalAlignment.Center, VerticalAlignment.Top)
                    .At(HorizontalAlignment.Center, VerticalAlignment.Top)
                    .Of(new JS("window"))
                )
            )
        )
        .OnRowInserting(@<text>
            function (e) {
                e.data.partnerId = masterPartner.partnerId;
            }
        </text>)
        .MasterDetail(m => m
            .Enabled(true)
            .Template(new TemplateName("grid-partner-branch-details"))
            .AutoExpandAll(false)
        )
        .Selection(s => s.Mode(SelectionMode.Single))
        .OnSelectionChanged(@<text>
            function(e) {
                e.component.collapseAll(-1);
                e.component.expandRow(e.currentSelectedRowKeys[0]);
            }
        </text>)
    )
}

@using (Html.DevExtreme().NamedTemplate("grid-partner-branch-details"))
{
    @(Html.DevExtreme().TabPanel()
        .FocusStateEnabled(false)
        .ElementAttr("class", "tabPanel")
        .Items(items =>
        {
            items.Add()
                .Title("Sales People")
                .Template(new TemplateName("grid-partner-branch-salespeople"))
                .Option("masterPartnerBranch", new { branchId = new JS("data.Id") });
        })
    )
}

@using (Html.DevExtreme().NamedTemplate("grid-partner-branch-salespeople"))
{
    @(Html.DevExtreme().DataGrid<SalesPerson>()
        .ID("grid-partner-branch-staff" + new JS("masterPartnerBranch.branchId"))
        .ShowBorders(true)
        .HeaderFilter(f => f.Visible(false))
        .DataSource(d => d.Mvc()
            .Controller(nameof(EnumController.SalesPeople))
            .LoadAction("GetSalesPeopleByBranch")
            .LoadParams(new
            {
                branchId = new JS("masterPartnerBranch.branchId")
            })
            .InsertAction("Post")
            .UpdateAction("Put")
            .DeleteAction("Delete")
            .Key("Id")
        )
        .Paging(p => p.PageSize(5))
        .Columns(columns =>
        {
            columns.AddFor(m => m.ContactName);
            columns.AddFor(m => m.ContactNumber);
            columns.AddFor(m => m.EMail);
        })
        .Editing(e =>
            e.Mode(GridEditMode.Popup)
            .UseIcons(true)
            .AllowAdding(true)
            .AllowUpdating(true)
            .AllowDeleting(true)
            .Popup(p =>
                p.Title(nameof(PartnerBranch))
                .ShowTitle(true)
                .DragEnabled(false)
                .CloseOnOutsideClick(true)
                .Position(pos => pos
                    .My(HorizontalAlignment.Center, VerticalAlignment.Top)
                    .At(HorizontalAlignment.Center, VerticalAlignment.Top)
                    .Of(new JS("window"))
                )
            )
        )
        .OnRowInserting(@<text>
            function (e) {
                e.data.branchId = masterPartnerBranch.branchId;
            }
        </text>)
        .Selection(s => s.Mode(SelectionMode.Single))
        .OnSelectionChanged(@<text>
            function(e) {
                e.component.collapseAll(-1);
                e.component.expandRow(e.currentSelectedRowKeys[0]);
            }
        </text>)
    )
}
